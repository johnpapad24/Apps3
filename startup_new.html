<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Hello World!</title>
  <link href="popupwindow.css" rel="stylesheet">
  <link href="bootstrap.min.css" rel="stylesheet">
  <link href="program.css" rel="stylesheet">
	<script src="jquery-3.6.0.min.js"></script>
  <script src="bootstrap.min.js"></script>
	<script src="popupwindow.js"></script>
  <script src="functions.js"></script>
</head>
<body>
  <div class="md-checkbox" style="display:none; margin-left:0.2em">
  <input type="checkbox" id="darkmodeswitch" onclick="">
  <label for="darkmodeswitch"></label>
</div>
<div id="logwindow" style="display:none; height: calc(100% - 40px);" >
  <div style="width:100%; height:100%;">
  <div style="display: block; margin:auto; height: 100%; width:100%;"><textarea id="logtextarea" style="height: 100%; width:100%; resize:none; min-height:150px; min-width:350px; border-radius:2px;" readonly></textarea>
  <button style="left: 50%; position: relative; -ms-transform: translate(-50%); transform: translate(-50%); " class="btn btn-primary" onclick="$('#logwindow').PopupWindow('Close');">OK</button>
</div>
</div>
</div>
  <div style="text-align:center; display: block; vertical-align:middle; margin-left: auto;
    margin-right: auto; position: relative;">
      <img style="" src="Resources/splash.jpeg">
  </div>


  <div class="progress" style="display:block; margin:auto; text-align:center; position: relative; max-width:500px; margin-top:10px;">
    <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%;">0%</div>
  </div>

  <div style="text-align:center; display: block; margin-top:10px">
    <span id="processtext">Initializing...</span>
  </div>
  <div id="startupprogesserrordiv" style="display: none; margin: auto; text-align:center;">
    <img style="vertical-align:middle;" src="Resources/error-icon.png" width="48" height="48">
    <span id="startupprogesserrordivspan" style="color: red; font-size: 18px; font-weight: bold;"></span>
  </div>
  <div style="text-align:center;">
    <button class="btn btn-info" id="logbutton" onclick="showlogwindow();" style="margin:auto; text-align:center; display:none;">Show Log</button>
  </div>



</body>
<script>
function startupprocesserror_js(message){
  document.getElementsByClassName('progress-bar').item(0).className+=' progress-bar-danger';
  document.getElementById("startupprogesserrordivspan").innerHTML=message;
  document.getElementById("startupprogesserrordiv").style.display="block";
  document.getElementById("logbutton").style.display="block";

}
function startupprogessor(step,totalsteps,processname){

  var percent=Math.round((step/totalsteps)*100);
  document.getElementsByClassName('progress-bar').item(0).setAttribute('aria-valuenow',percent);
  document.getElementsByClassName('progress-bar').item(0).setAttribute('style','width:'+percent+"%;");
  document.getElementsByClassName('progress-bar').item(0).innerHTML=percent+"%";
  document.getElementById('processtext').innerHTML=processname;
}
function logonstartup(message,status){
  var check;
  $.ajax({
             url: '/Apps/Startuplogger.php',
             async:false,
             type: 'POST',
             data:{message:message,status:status},
             success: function(data) {
               if(data==false){
                 startupprocesserror_js("Error! Write to log file failed.");
                 check=false;
               }
               check=true;
             },
             fail: function(data){
               startupprocesserror_js("Error! Write to log file failed.");
              check=false;
             }
         });
         return check;

}



function createlogstep(step,totalsteps){
  //initialization
  $.ajax({
             url: '/Apps/Logcreator.php',
             async:true,
             type: 'POST',
             fail: function(data){
                startupprocesserror_js("Error! Log file creation failed.");
                return;
             }
         }).then(function(data) {
           if(data=="0"){
              var check=logonstartup("Starting initialization...","");
              if(check==false){
                startupprocesserror_js("Error! Cannot write to log file.");
                return;
              }
              startupprogessor(step+1,totalsteps,"Checking internet connection...");
               checkinginternetconnectionstep(step+1,totalsteps);
           }
           else{
             startupprocesserror_js("Error! Log file creation failed.");
             return;
           }});



}


function checkinginternetconnectionstep(step,totalsteps){
  //checking internet connection
  $.ajax({
             url: '/Apps/Checkinternetconn.php',
             async:true,
             type: 'POST',

             fail: function(data){
               var check=logonstartup("Checking internet connection...","FAILED");
               if(check==false){
                 startupprocesserror_js("Error! Cannot write to log file.");
                  return;
               }
               else{
               startupprocesserror_js("Error! Cannot connect to the internet.");
              }
             }

         }).then(function(data) {
                    if(data=="0"){
                        var check=logonstartup("Checking internet connection...","OK");
                        if(check==false){
                          startupprocesserror_js("Error! Cannot write to log file.");
                          return;
                        }
                        else{
                          startupprogessor(step+1,totalsteps,"Checking TLE File...");
                          checktlefilestep(step+1,totalsteps);
                        }
                    }
                    else{
                      var check=logonstartup("Checking internet connection...","FAILED");
                      if(check==false){
                        startupprocesserror_js("Error! Cannot write to log file.");
                        return;
                      }
                      else{
                        startupprocesserror_js("Error! Cannot connect to the internet.");
                        return;
                      }

                    }


                  });
}
function checktlefilestep(step,totalsteps){
  $.ajax({
             url: '/Apps/Checktlefile.php',
             async:true,
             type: 'POST',
             fail: function(data){
               var check=logonstartup("Checking TLE file...","FAILED");
               if(check==false){
                 startupprocesserror_js("Error! Cannot write to log file.");
                 return;
               }
               else{
               startupprocesserror_js("Error! TLE file not found.");
               return;
              }
             }
       }).then(function(data){
              if(data=="0"){
                 var check=logonstartup("Checking TLE file...","OK");
                 if(check==false){
                   startupprocesserror_js("Error! Cannot write to log file.");
                   return;
                 }
                 else {
                   startupprogessor(step+1,totalsteps,"Connecting to database...");
                   initializedatabaseconnectionstep(step+1, totalsteps);


                 }
              }
            });

}
function initializedatabaseconnectionstep(step,currentsteps){
  $.ajax({
             url: '/Apps/Checkconnectdb.php',
             async:true,
             type: 'POST',

             fail: function(data){
              var check=logonstartup("Connecting to database...","FAILED");
               if(check==false){
                 startupprocesserror_js("Error! Cannot write to log file.");
                 return;
               }
               else{
               startupprocesserror_js("Error! Cannot connect to database.");
               return;
             }
           }}).then(function(data) {
           if(data=="0"){
              var  check=logonstartup("Connecting to database...","OK");
                if(check==false){
                  startupprocesserror_js("Error! Cannot write to log file.");
                  return;
                }
                else{
                  startupprogessor(step+1,totalsteps,"Updating database...");
                  updatedbstep(step+1,totalsteps);
                }

           }
           else{
            var check=logonstartup("Connecting to database...","FAILED");
             if(check==false){
               startupprocesserror_js("Error! Cannot write to log file.");
              return;
             }
             else{
             startupprocesserror_js("Error! Cannot connect to database.");
              return;
            }
           }

         });
}
function updatedbstep(step,totalsteps){
  $.ajax({
             url: '/Apps/Dbupdater.php',
             async:true,
             type: 'POST',
             fail: function(data){
              var check=logonstartup("Updating database...","FAILED");
               if(check==false){
                 startupprocesserror_js("Error! Cannot write to log file.");
                  return;
               }
               else{
               startupprocesserror_js("Error! Cannot update database.");
               return;
              }
             }
         }).then(function(data) {
           if(data==0){
                var check=logonstartup("Updating database...","OK");
                if(check==false){
                  startupprocesserror_js("Error! Cannot write to log file.");
                  return;
                }
                else{
                  startupprogessor(step+1,totalsteps,"Checking/creating settings file...");
                  settingsfilecreatorstep(step+1,totalsteps);
                }
           }
           else{
            var check=logonstartup("Updating database...","FAILED");
             if(check==false){
               startupprocesserror_js("Error! Cannot write to log file.");
               return;
             }
             else{
             startupprocesserror_js("Error! Cannot update database.");
             return;
            }
           }

         });
}
function settingsfilecreatorstep(step,totalsteps){
  $.ajax({
           url: '/Apps/Settingsfilecreator.php',
           async:true,
           type: 'POST',

           fail: function(data){
             var check=logonstartup("Checking/creating settings file...","FAILED");
             if(check==false){
               startupprocesserror_js("Error! Cannot write to log file.");
              return;
             }
             else{
             startupprocesserror_js("Error! Creation of settings file failed.");
             return;
            }
           }
       }).then(function(data) {
         if(data=="0"){
              var check=logonstartup("Checking/creating settings file...","OK");
              if(check==false){
                startupprocesserror_js("Error! Cannot write to log file.");
                return;
              }
              else{
                startupprogessor(step+1,totalsteps,"Starting up...");
                var check=logonstartup("Started Cesium environment Load...","");
                if(check==false){
                  startupprocesserror_js("Error! Cannot write to log file.");
                  return;
                }
                }
                if(check==true){
                  window.location.replace("/Apps/main.html");
                }



         }
         else{
           var check=logonstartup("Checking/creating settings file...","FAILED");
           if(check==false){
             startupprocesserror_js("Error! Cannot write to log file.");
             return;
           }
           else{
           startupprocesserror_js("Error! Creation of settings file failed.");
          return;
          }
         }

       });
}
var totalsteps=6;
var check=true;
var percent=0;
var step=0;

createlogstep(step,totalsteps);





//programstartup();



</script>
</html>
